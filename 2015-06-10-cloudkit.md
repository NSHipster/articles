---
title: CloudKit
author: Croath Liu
category: Objective-C
excerpt: "As an iOS developer, you need to write backend code sometimes if you want to make an application all by your own. However, it's not easy to maintain a server for a long time. Fortunately, we have CloudKit now."
---

As an iOS developer, you need to write backend code sometimes if you want to make an application all by your own. However, it's not easy to maintain a server for a long time. 

Some of you may say that you can write backend code, but there are more than just writing backend code, such as maintenance. The worst situation is not people don't like your application, but your server broke by heavy traffic.

Fortunately, we have CloudKit now. Apple will take care of everything like this. All you need to do is to focus on how to make your application better. 

## What is CloudKit

Maybe you've heard iCloud Drive before. iCloud Drive is somewhere that we can store our user's data and file in and access them easily from other devices. And CloudKit is the framework helping you to do this easily.  

CloudKit offers you tons of API to access iCloud. You can create a user model inside your application based on user's iCloud account. Meanwhile, you also have a public global database to store application-level data. You also can save large files and bulk data in iCloud Drive. All you need is operating this like working on local files but all the operations you did will be sent to the cloud. So your users can use it in their other devices.

Overall, CloudKit is a framework that could replace backend web services of old school like databases, file storage and user system. With CloudKit's help, you don't need to concern about this part, so you can focus your energy on your application. 

## Get into CloudKit

### Enable CloudKit

We have already talked about how powerful CloudKit is, now it is the time to show you how to use it. It is pretty simple. All you need is to turn on `iCloud` and check `CloudKit` in the project panel of Xcode.

### Fundamental CloudKit Objects

There are 7 different fundamental objects in CloudKit. You may have seen this in your programming career but there are some slightly differences.

- Container: A container is like a sandbox. An application can only use the resources inside its container. The container is located at the very outer border and each application has one and only one separate container. (In fact, you can allow other applications to access your container by configuring in CloudKit Dashboard.)
- Database: Database is the place that you put all your data in. There are two different kinds of database, private database and global database. Private database is where you store sensitive data like user's information. Global database is where you store shared data. For example, if you are working on an application like Swarm. You may want to store every checkin in private database but store places information in global database.
- Record: A record is a piece of data inside your database. It is stored as a key-value pair. For now, you can save `NSString`, `NSNumber`, `NSData`, `NSDate`, `CLLocation`, `CKReference`, `CKAsset` and `NSArray` of  all the types we listed above as a record. 
- Record Zone: Record is not stored scattered in database. It is located at record zones. Every application has a default record zone, and you also can have your custom record zone.
- Record Identifier: Record identifier is the unique label of a record. It use for locating a record.
- References: Reference is like the relationship in RDBMS. Back to the Swarm example, there may be many people checkin at the same place and you need to establish a reference places and check-ins.
- References: The relationship between datas. Look back our LBS application there are many check-ins under a place, so that there will be an including reference between places and check-ins.
- Assets: i.e. resources. It is like binary files or bulk data. For example, user's picture should be stored as asset.

### Convenience API

Convenience API is the API to do basic operations such as write, read and edit.

Let's finish our check-in application.

First, create a new place and save it:

(Remember to `#import <CloudKit/CloudKit.h>`)

~~~{objective-c}
CKRecordID *greatID = [[CKRecordID alloc] initWithRecordName:@"GreatPlace"];
CKRecord *place = [[CKRecord alloc] initWithRecordType:@"Place" recordID:greatID];
    
CKDatabase *publicDB = [[CKContainer defaultContainer] publicCloudDatabase];
[publicDB saveRecord:place completionHandler:^(CKRecord *savedPlace, NSError *error) {
    // handling error here
}];
~~~

CloudKit will connect to the Internet when `saveRecord:completionHandler:` method is invoked asynchronously. _Remember_ to handle the error in the block cause the Internet connection is unstable. A good application deserves perfect error handling logic.


Read a place information:

~~~{objective-c}
CKContainer *defaultContainer = [CKContainer defaultContainer];
CKDatabase *publicDB = [defaultContainer publicCloudDatabase];
    
CKRecordID *greatID = [[CKRecordID alloc] initWithRecordName:@"GreatPlace"];
    
[publicDB fetchRecordWithID:greatID completionHandler:^(CKRecord *fetchedPlace, NSError *error) {
    // handling error here
}];
~~~

Edit an existing place's information:

~~~{objective-c}
CKContainer *defaultContainer = [CKContainer defaultContainer];
CKDatabase *publicDB = [defaultContainer publicCloudDatabase];
    
CKRecordID *greatID = [[CKRecordID alloc] initWithRecordName:@"GreatPlace"];
    
[publicDB fetchRecordWithID:greatID completionHandler:^(CKRecord *fetchedPlace, NSError *error) {
    if (error == nil) {
        NSString *name = fetchedPlace[@"name"];
        fetchedPlace[@"name"] = [name stringByAppendingString:@" Door A"];
            
        [publicDB saveRecord:fetchedPlace completionHandler:^(CKRecord *savedPlace, NSError *error) {
            //...
        }];
    } else {
        //...
    }
}];
~~~

The progress of editing a record is pretty simple: read it, edit it then save it.

You can finish almost all the work you need to do with the convenience API. I don't know what do you feel about these API so far. But personally, I think it is much easier than writing backend code, maintaining a server and writing some code to communicate with it.

## Advanced Features

### Query

It is not enough to finish our check-in application only knowing these API. Now it is the time to add search function to it. 

To add a search function, you will need _Query_. A `CKQuery` object is made up of `RecordType`, `NSPredicate` and `NSSortDescriptors`.

> `NSPredicate` plays an important role here. It can do a string match query, a location range query, and combinations of simple queries refer to [document](https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKQuery_class/index.html#//apple_ref/occ/cl/CKQuery)

Let's say that I want all the places contains the name 'Apple Store':

~~~{objective-c}
CKContainer *defaultContainer = [CKContainer defaultContainer];
CKDatabase *publicDB = [defaultContainer publicCloudDatabase];
    
NSPredicate *predicate = [NSPredicate predicateWithFormat:@"name CONTAINS 'Apple Store'"];
    
CKQuery *query = [[CKQuery alloc] initWithRecordType:@"Place" predicate:predicate];
    
[publicDB performQuery:query
          inZoneWithID:nil
     completionHandler:^(NSArray *results, NSError *error) {
         
     }];
~~~

Based on this example, I believe you could make something like getting all the places within 1 mile around the user.

### Subscribe Notification


Now it's time to make an application after adding queries. But wait, did we forget something?

Yes. The Push Notifications. It's a critical part of all applications. 

Let's go back to our check-in application again. A sociable person may want a feature like getting notified if someone mentioned "party" around him or her. This is not impossible for CloudKit. CloudKit already provided something to achieve this.

~~~{objective-c}
CKContainer *defaultContainer = [CKContainer defaultContainer];
CKDatabase *publicDB = [defaultContainer publicCloudDatabase];
    
NSPredicate *predicate = [NSPredicate predicateWithFormat:@"description CONTAINS 'party'"];
    
CKSubscription *subscription = [[CKSubscription alloc] initWithRecordType:@"Checkin" predicate:predicate options:CKSubscriptionOptionsFiresOnRecordCreation];
    
CKNotificationInfo *info = [CKNotificationInfo new];
info.alertLocalizationKey = @"NEW_PARTY_ALERT_KEY";
info.soundName = @"NewAlert.aiff";
info.shouldBadge = YES;
    
subscription.notificationInfo = info;
    
[publicDB saveSubscription:subscription
         completionHandler:^(CKSubscription *subscription, NSError *error) {
             // ...
         }];
~~~

After receiving the notification:

~~~{objective-c}
- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo{
    CKNotification *ckNotification = [CKNotification notificationFromRemoteNotificationDictionary:userInfo];
    if (ckNotification.notificationType == CKNotificationTypeQuery) {
        CKQueryNotification *queryNotification = ckNotification;
        CKRecordID *recordID = [queryNotification recordID];
        // ...
    }
}
~~~

## More

As I said in the beginning, CloudKit can do much more than I showed you in this article. You can allow your user to add some pictures to their check-in. Reference in CloudKit allows you to get all the related check-ins in some certain places. Even more, CloudKit has an API allows you to find your users' friends who is also using your application by checking address book.

Maybe you already can not wait to try CloudKit that could free you from writing backend code, caring about server pressure, maintaining a large CDN network, renting a server or more. But.. wait. What about the price? How much does it cost? The answer is ... Free. Apple allows us using CloudKit to store up to 1PB resources file, 10 TB database, 5 TB resources transfer and 50 GB databases transfer per day.

* * *

CloudKit is a such amazing thing. I can not wait to see the awesome applications that you NSHipsters made with it. 

~~Currently, you can only use CloudKit on iOS or OS X. But imagine one day, the CloudKit becomes a smarter and more open BaaS platform. ~~

Currently, CloudKit is not only available on iOS or OS X. [CloudKit JS](https://developer.apple.com/library/prerelease/ios/documentation/CloudKitJS/Reference/CloudKitJavaScriptReference/index.html), and [web service](https://developer.apple.com/library/prerelease/ios/documentation/DataManagement/Conceptual/CloutKitWebServicesReference/Introduction/Introduction.html) are available now.

Imagine all the potential possibilities it could have. Don't you feel excited? Let's leave the answer to Apple.